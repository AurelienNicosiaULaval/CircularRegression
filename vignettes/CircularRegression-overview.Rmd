---
title: "Getting Started with CircularRegression"
author: "CircularRegression Team"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with CircularRegression}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

`CircularRegression` provides tools to fit regression models designed for circular
responses. This vignette introduces the main functionality of the package using
the `bison` data set included with the package. The demonstrations highlight
how to fit and interpret both the angular and consensus regression models.

# Loading the package and data

```{r load-data}
library(CircularRegression)

data(bison)
str(bison)
```

The `bison` data frame contains directional observations (`y.dir`) along with
predictor summaries (`y.prec` and `y.prec2`) that characterize preceding animal
headings. The formulas used in this vignette follow the convention of placing the
circular response on the left-hand side.

# Angular regression model

The angular regression model links the response direction to previous directions
through trigonometric transformations. The example below fits the simplified
angular regression model with `y.dir` as the response and two predictors that
capture previous movement directions.

```{r angular-fit}
ang_fit <- angular(y.dir ~ y.prec + y.prec2, data = bison)
ang_fit
```

A summary provides parameter estimates and associated inference information.

```{r angular-summary}
summary(ang_fit)
```

Diagnostic plots help assess the adequacy of the model by visualizing residuals
and fitted directions.

```{r angular-plot, fig.width=7, fig.height=6}
plot(ang_fit)
```

# Consensus regression model

The consensus model extends the angular regression framework by explicitly
modelling the concentration parameter. The following example fits a consensus
model using the same predictors.

```{r consensus-fit}
cons_fit <- consensus(y.dir ~ y.prec + y.prec2, data = bison)
cons_fit
```

You can inspect the estimated parameters and goodness-of-fit criteria via the
summary method.

```{r consensus-summary}
summary(cons_fit)
```

For a more detailed diagnostic assessment, the plotting method provides a suite
of charts similar to those available for linear models.

```{r consensus-plot, fig.width=7, fig.height=6}
plot(cons_fit)
```

# Likelihood Ratio test

```{r}
fit_full <- angular(y.dir ~ y.prec + y.prec2 + x.gap + z.gap:x.gap, data = bison)
fit_reduced    <- angular(y.dir ~ y.prec + y.prec2, data = bison)
lrt_result  <- angular_lrtest(full = fit_full, reduced = fit_reduced)
print(lrt_result)
anova(fit_full, fit_reduced, test = "LRT")
```

# random effect

```{r, eval=FALSE}
dat <- data("Sandhopper")
to_rad <- function(x) x * pi/180
for (v in c("LN1","LN2","LN3","LN4","LN5","Azimuth","DirW")) dat[[v]] <- to_rad(dat[[v]])
dat$Eye <- log(dat$Odmx*dat$Odmn) - log(dat$Osmx*dat$Osmn)

# Retenir les 59 individus sans NA comme dans l'annexe
keep <- c(1:14,16:49,51:53,57:64)
dat2 <- dat[keep, ]

# "Long" : 5 lignes par individu
long <- do.call(rbind, lapply(seq_len(nrow(dat2)), function(i) {
  data.frame(
    id   = i,
    Azimuth = dat2$Azimuth[i],
    DirW    = dat2$DirW[i],
    SpeedW  = dat2$SpeedW[i],
    Eye     = dat2$Eye[i],
    Rep     = 0:4,
    LN      = as.numeric(dat2[i, paste0("LN", 1:5)])
  )
}))

# Modèle final de l'article (Eq. (11) et modèle restreint) :
# y ~ Azimuth + DirW + 0 + DirW:SpeedW + 0:Eye + (pi/2):Eye + (pi/2):Rep
# On réutilise la grammaire "x:z" de angular()
long$Zero   <- 0
long$Pi2    <- pi/2

fit <- angular_re(
  LN ~ Azimuth + DirW + Zero + DirW:SpeedW + Zero:Eye + Pi2:Eye + Pi2:Rep,
  data = long,
  cluster = long$id,
  model = "simplified"
)
print(fit)

# Résumés utiles
coef(fit)
vcov(fit)                 # SE modèle
vcov(fit, robust = TRUE)  # SE sandwich
head(ranef(fit))          # prédicteurs a_hat


# flèches avec longueur A1(kappa_a) (interprétable)
plot_ranef.angular_re(fit)

# longueur unitaire + labels de grappes
plot_ranef.angular_re(fit, scale = "unit", labels = TRUE)

## Rosaces (deux panneaux)
plot(fit, which = "both")             # fixed + conditional
plot(fit, which = "fixed")
plot(fit, which = "conditional", points = FALSE)

## Prédictions
library(CircStats)
new_df <- data.frame(
  LN = rvonmises(5, mu = 0, kappa = 1), # ex: 5 valeurs aléatoires
  Azimuth = rep(to_rad(45), 5),       # ex: 45° en radians
  DirW    = rep(to_rad(90), 5),       # ex: 90°
  Zero    = 0,                        # variable "constante"
  SpeedW  = rep(0.5, 5),              # ex: vitesse du vent
  Eye     = rep(mean(long$Eye), 5),   # ex: utiliser moyenne observée
  Pi2     = pi/2,
  Rep     = 0:4                       # répétitions
)
# marginales (nouvelle grappe)
mu_new <- predict(fit, newdata = new_df, type = "marginal")

# conditionnelles pour des observations appartenant à des grappes connues
mu_cond <- predict(fit, newdata = df_existing, cluster = df_existing$id,
                   type = "conditional")

# conditionnelles avec un a_hat imposé (p.ex. scénario)
mu_scenario <- predict(fit, newdata = new_df, type = "conditional", a_hat = 0.3)





```


# Additional models and utilities

Besides the angular and consensus models, the package exposes additional
regression frameworks such as the decentered predictor model, Presnell model,
and mean direction model. Refer to the function documentation for these
methods for more examples (`?decentredPredictorModel`, `?presnellModel`,
etc.).

# Session information

```{r session-info}
sessionInfo()
```
